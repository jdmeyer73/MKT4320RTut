```{r echo=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(cowplot)
```
# Linear Regression

Sources for this chapter:

* *R for Marketing Research ad Analytics, Second Edition* (2019). Chris Chapman and Elea McDonnell Feit
    * [http://r-marketing.r-forge.r-project.org/index.html](http://r-marketing.r-forge.r-project.org/index.html)
* ggplot2: [https://ggplot2.tidyverse.org/](https://ggplot2.tidyverse.org/)

Data for this chapter:

* Once again, the [airlinesat.rdata]("Data/airlinesat.rdata") is used. Load it now.
    ```{r t3loaddata}
    # You may need to change the directory
    load("Data/airlinesat.rdata")
    ```

## Introduction

Base R is typically sufficient for performing most regression tasks.  Some additional packages may be used for "prettier" tables or extracting results to make useful plots.

\newpage
## The `lm()` Function

* Basic linear regression is performed using the `lm()` function.
* Usage: `lm(formula, data)`
* In R, a <span style="font-family: Courier;">formula</span> is represented by dependent variables on the left side separated from the independent variables on the right side by a tilde(`~`), such as: `dv ~ iv1 + iv2`
    * For interactions between independent variables, use either `*` or `:`
        * `*` will include the interaction term AND each main effect
        * `:` will include ONLY the iteraction term
        * Examples:
            * `y ~ x1 + x2*x3` is the same as:<br>
            $y=x_1+x_2+x_3+(x_2\times x_3)$
            * `y ~ x1 + x2:x3` is the same as:<br>
            $y=x_1+(x_2\times x_3)$
            * `y ~ x1 + x2 + x2:x3` is the same as:<br>
            $y=x_1+x_2+(x_2\times x_3)$
* If `lm()` is run by itself, R only outputs the coefficients
    ```{r t3lm1}
    lm(nps ~ age + nflights, airlinesat)
    ```
<caption>(\#tab:t3lm1) Coefficients from `lm()` call</caption>

* However, if the results of the `lm()` call are assigned to an object, the `summary()` function can be used to get much more detailed output
    ```{r t3lm2, cache=TRUE}
    model1 <- lm(nps ~ age + nflights, airlinesat)
    summary(model1)
    ```
<caption>(\#tab:t3lm2) Summary results from `lm()` call</caption>
* For "nicer" looking results, the package `jtools` can be used
    * NOTE: `jtools` is no available in BGSU's Virtual Computing Lab
    ```{r t3lm3, cache=TRUE}
    library(jtools)
    summ(model1,   # Saved object from before
         digits=4, # How many digits to display in each column
         model.info = FALSE)  # Suppress extraneous information
    ```
<caption>(\#tab:t3lm3) Summary results from `lm()` using `jtools` package</caption>

* To get standardized beta coefficients, use the [lm_beta](./lm_beta.R) user defined function. 
    ```{r t3lmbeta}
    source("lm_beta.R")  # Download lm_beta.R and put in working directory
    lm_beta(model1, # Saved object with results
            digits=4)  # Number of digits to diplsy
    
    ```
<caption>(\#tab:t3lmbeta) Standardized Beta Coefficients</caption>

\newpage
## Prediction

The function `predict.lm()` can be used to predict the DV based on values of the IVs. This function is used in the margin plots covered in the next two sections. To use this function, we must pass a data frame of values to the function, where the data frame contains ALL of the IVs and the value for each IV that we want.

Suppose we wanted to predict, with a confidence interval, the `nps` of someone that is 45 years old and had 25 flights on the airline, and also someone that is 25 years old and had 45 flights on the airline. First, we create the data frame of values (see \@ref(using-vectors-in-line)):
```{r t3prediction1, cache=TRUE}
values <- data.frame(age=c(45, 25), nflights=c(25, 45))  # Create data frame
values  # Verify values
```
Second the data frame is passed to the `predict.lm()` function with confidence intervals requested:
```{r t3prediction2, cache=TRUE}
predict.lm(model1,   # The model we are using to predict
           values,   # The data frame of values to predict with
           interval="confidence")   # Request confidence interval
```

\newpage
## Margin Plots

In R, margin plots are a multistep process:

1. Create a data frame of IV values to use in the prediction.
    1. For the variable of interest, this is usually a sequence of values from about the minimum to about the maximum
    2. For other variables in the model:
        1. Factor variables are usually evaluated at each level of the factor
        2. Continuous variables are usually evaluated an the sample mean for each level of the factor variable (if factor variables are present)
2. Use the `predict.lm()` function to use the model results to predict the linear fit of the "simulated" observations in the new data frame
3. Use `ggplot` to create the margin plot

``` {r t3marginplot1, message=FALSE, fig.cap="Single margin plot"}
# Want to predict 'nps' for different levels of 'age'
#     when 'nflights' is at the mean
# Because we often do this for other continuous variables, we first
#     create a df with mean values of all continuous variables at
#     different levels of the factor variable (if there are any)
# NOTE: variable names must be EXACTLY the same as in model
m.ivs <- airlinesat %>%
   group_by() %>%   # NOTE: No factor variables for this model
   summarise(age=mean(age, na.rm=TRUE),
             nflights=mean(nflights, na.rm=TRUE))

# Second, create a df of values to predict with, using 'merge'
#     'merge' simply merges data frames
age.pred <- merge(data.frame(age=seq(15, 105, 10)), # Variable of interest
                  m.ivs[,c("nflights")]) # Mean levels of other variables

# Third, use model results to predict DV for values in 'age.pred' data frame
#     Predicted values and confidence intervals get appended to data frame
#     New variables are called:
#          'pfit'  = linear prediction from model
#          'p$lwr' = lower confidence interval for prediction
#          'p$upr' = upper confidcent interval for prediction
age.pred$p <- as.data.frame(
   predict.lm(model1,    # Object with model results    
              age.pred,  # df of IV values to predict with
              interval="confidence"))   # Request CIs

# Last, use 'age.pred' for margin plot
age.pred %>%
   ggplot(aes(x=age,   # Age on x-axis
              y=p$fit)) +   # 'nps' prediction on y-axis
   geom_line(size=1) +   # Draw predicted line
   geom_ribbon(aes(ymin=p$lwr,  # Draws the confidence interval bands
                   ymax=p$upr),
               alpha=0.2) + # Sets transparency level
   labs(x="Age", y="Linear Prediciton")
```

### Separate Margin Plots

* If creating separate plots for each continuous IV, it is best to have the prediction (<span style="font-family: Courier;">y</span>) variable have the same scale
    * Doing so might take some trial and error after looking at graphs once
* Use the function `plot_grid()` from the `cowplot` package to make the plots appear in the same figure
    * Save each plot as an object, then pass the objects to `plot_grid()`
```{r t3marginplot2, message=FALSE, fig.cap="Separate margin plots"}
library(cowplot)
# Ask for min and max of the 95% confidence bands to adjust y-axis
min(age.pred$p$lwr)
max(age.pred$p$upr)
# Save previous plot (for 'age') as plot 1
plot1 <- age.pred %>%
    ggplot(aes(x=age,y=p$fit)) +
        geom_line(size=1) + 
        geom_ribbon(aes(ymin=p$lwr, ymax=p$upr), alpha=0.2) +
        labs(x="Age", y="Linear Prediciton") +
        scale_y_continuous(limits=c(5.25,9.25))  # Set scale limits for y-axis

# Create second plot for 'nflights' using procedure above
nflights.pred <- merge(data.frame(nflights=seq(0, 150, 15)),
                       m.ivs[,c("age")])
nflights.pred$p <- as.data.frame(predict.lm(model1, nflights.pred,
                                            interval="confidence"))
min(nflights.pred$p$lwr)
max(nflights.pred$p$upr)
    
plot2 <- nflights.pred %>%
    ggplot(aes(x=nflights, y=p$fit)) +
        geom_line(size=1) +
        geom_ribbon(aes(ymin=p$lwr,ymax=p$upr),alpha=0.2) +
        labs(x="Number of Flights", y="Linear Prediciton")  +
        scale_y_continuous(limits=c(5.25,9.25))  # Set scale limits for y-axis
    
# Use 'cowplot' function 'plot_grid' to combine plots
cowplot::plot_grid(plot1,plot2)
```
    
### Continuous IV at Levels of Factor IV

* Margin plots when one of the variables is a factor variable are done in much the same way, but require an `aes(color=factor)` to produce different lines for each level of the factor
```{r t3marginplot3, cache=TRUE, message=FALSE}
# Run new model with 'age' and 'flight_purpose' interaction
model2 <- lm(nps ~ age*flight_purpose + nflights, airlinesat)
summary(model2)
```
<caption>(\#tab:t3marginplot3) Summary results of model with interaction</caption>
```{r t3marginplot4, cache=TRUE, message=FALSE, fig.cap="Margin plot with factor variable"}
m.ivs <- airlinesat %>%
   group_by(flight_purpose) %>%   # Factor variable in model
   summarise(age=mean(age, na.rm=TRUE),
             nflights=mean(nflights, na.rm=TRUE))

age.pred <- merge(data.frame(age=seq(15, 105, 10)), # Variable of interest
                  m.ivs[,c("nflights", "flight_purpose")]) # Other variables

age.pred$p <- as.data.frame(predict.lm(model2, age.pred,
                                       interval="confidence"))

nflights.pred <- merge(data.frame(nflights=seq(0, 150, 15)),
                       m.ivs[,c("age", "flight_purpose")])

nflights.pred$p <- as.data.frame(predict.lm(model2, nflights.pred,
                                            interval="confidence"))

plot3 <- age.pred %>%
    ggplot(aes(x=age,y=p$fit, 
              color=factor(flight_purpose))) + # Different lines for factor
        geom_line(size=1) +     
        geom_ribbon(aes(ymin=p$lwr, ymax=p$upr,
                        fill=factor(flight_purpose)),  # Different fill color 
                    alpha=0.2) +
        labs(x="Age", y="Linear Prediciton", 
             fill="Flight Purpose", color="Flight Purpose") +
        theme(legend.position="bottom") +
        scale_y_continuous(limits=c(5,10.5))

plot4 <- nflights.pred %>%
    ggplot(aes(x=nflights,y=p$fit, color=factor(flight_purpose))) + 
        geom_line(size=1) +     
        geom_ribbon(aes(ymin=p$lwr, ymax=p$upr,
                   fill=factor(flight_purpose)),alpha=0.2) +
        labs(x="Number of Flights", y="Linear Prediciton", 
             fill="Flight Purpose", color="Flight Purpose") +
        theme(legend.position="bottom") +
        scale_y_continuous(limits=c(5,10.5))

cowplot::plot_grid(plot3, plot4)
```